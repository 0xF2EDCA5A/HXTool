{% extends "layout.html" %}
{% block title %}HXTool - Alerts{% endblock %}
{% block content %}

<script>

	function getHistoricDate(days) {
		var historicDate = new Date();
		historicDate.setDate(historicDate.getDate() - days);
		return(historicDate.toISOString().substr(0, 10))
	}

	$(document).ready(function() {

		var fullDate = new Date()
		var currentDate = fullDate.toISOString().substr(0, 10);

		var pastDate = getHistoricDate(1);

		$("#from").val(pastDate);
		$("#to").val(currentDate);

		$("#refresh").click(function() {
			$('#shader').show();
			alert_datatable.ajax.url( '/api/v1/datatable_alerts_full?startDate=' + $("#from").val() + '&endDate=' + $("#to").val() ).load(function ( json ) {
				$('#shader').hide();
			});
		});

		$("input[id^='nav_']").click(function() {
			var dArr = $(this).attr('id').split("_");
			var navDate = getHistoricDate(dArr[1]);
			$("#from").val(navDate);
			$("#to").val(currentDate);
			$("#refresh").click();
		});		

		$(document).on('click', '.showannotation', function() {
			aArr = $(this).attr("id").split("_");
			showPopup(600, 1200, "/annotatedisplay?alertid=" + aArr[1], "annotateDisplayTable");
		});

		$("#alertAutoRefresh").click(function() {
			if ($(this).is(":checked")) {
				alertAuto = setInterval(function () {
					$('#shader').show();
					alert_datatable.ajax.reload(function ( json ) {
						$('#shader').hide();	
					});
				}, $("#alertAutoRefreshInterval").val() * 1000);
			}
			else {
				clearInterval(alertAuto);
			}			
		});

		$(document).on('click', '.addannotation', function() {
			aArr = $(this).attr("id").split("_");
			$("#annotationBoxID").val(aArr[1]);

			$('#annotationBox').center();

			$('#shader').show();
			$("#annotationBox").show();
		});

		$(document).on('click', '.postannotation', function() {
			alertid = $("#annotationBoxID").val();
			$.post( "/annotateadd", $( "#annotationForm" ).serialize(), function( data ) {
				$("#annotateText").val("");
 				alert_datatable.ajax.reload();
				$("#annotationBox").hide();
				$('#shader').hide();
			});
		});

		$(document).on('click', '.cancelannotation', function() {
			$("#annotateText").val("");
			$("#annotationBox").hide();
			$('#shader').hide();
		});



		var alert_datatable = $('#alertTable').DataTable( {
			"ajax": "/api/v1/datatable_alerts_full?startDate=" + pastDate + "&endDate=" + currentDate,
			"paging":   false,
			"ordering": false,
			"info":     false,
			"searching": false,
			"processing": true,
			"columns": [
				{ "title": "", "data": "platform" },
				{ "title": "Hostname", "data": "hostname" },
				{ "title": "Domain", "data": "domain" },
				{ "title": "Event at", "data": "event_at" },
				{ "title": "Age", "data": "age" },
				{ "title": "Source", "data": "source" },
				{ "title": "Threat", "data": "threat" },
				{ "title": "Resolution", "data": "resolution" },
				{ "title": "State", "data": "annotation_max_state" },
				{ "title": "Annotations", "data": "annotation_count" },
				{ "title": "Action", "data": "action" }
			],
			"createdRow": function( row, data, index ) {
				if (data.annotation_max_state == 1) {
					$('td', row).eq(8).css( 'background-color', '#fffce0' );
				}
				else if (data.annotation_max_state == 2) {
					$('td', row).eq(8).css( 'background-color', '#e0ffe3' );
				}
			},
			"columnDefs": [	
				{
				 "targets": 0,
				 "width": "20px",
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display'){
				 		if (data == "win") {
				 			data = '<img style="width: 20px;" src="/static/ico/windows.svg">';
				 		}
				 		else if (data == "mac") {
				 			data = '<img style="width: 20px;" src="/static/ico/mac.svg">';
				 		}
				 		else if (data == "linux") {
				 			data = '<img style="width: 20px;" src="/static/ico/linux.svg">';
				 		}
				 		else {
				 			data = "N/A"
				 		}
				 	}
				 	return data;
				 }
				},
				{
				 "targets": 1,
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display'){
				 		myArr = data.split("___");
				 		data = '<a class="hostLink" href="/hosts?host=' + encodeURIComponent(myArr[1]) + '&alertid=' + encodeURIComponent(myArr[2]) + '">' + myArr[0] + '</a>';
				 	}
				 	return data;
				 }
				},
				{
				 "targets": 3,
				 "width": "150px"
				},
				{
				 "targets": 4,
				 "width": "120px"
				},
				{
				 "targets": 5,
				 "width": "60px"
				},
				{
				 "targets": 7,
				 "width": "80px"
				},
				{
				 "targets": 8,
				 "width": "70px",
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display'){
				 		if (data == 1) {
				 			data = "Investigating";
				 		}
				 		else if (data == 2) {
				 			data = "Completed";
				 		}
				 		else {
				 			data = "New"
				 		}
				 	}
				 	return data;
				 }
				},
				{
				 "targets": 9,
				 "width": "80px",
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display'){
				 		data = "<a href='#' class='tableActionButton showannotation' id='showannotation_" + row.DT_RowId + "'>show (" + data + ")</a>";
				 	}
				 	return data;
				 }
				},
				{
				 "targets": 10,
				 "width": "80px",
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display'){
				 		data = "<a href='#' class='tableActionButton addannotation' id='annotate_" + row.DT_RowId + "'>annotate</a>";
				 	}
				 	return data;
				 }
				},
				{"className": "dt-center", "targets": [0, 3, 4, 5, 7, 8, 9, 10]}
			]
		});		

	});

</script>

<div style='float: left; margin-bottom: 15px; font-family: open_sans,"Helvetica Neue",Helvetica,Roboto,Arial,sans-serif; font-size: 12px;'>
	<input class='tableActionButton' type='button' id='nav_1' value='today'>
	<input class='tableActionButton' type='button' id='nav_7' value='week'>
	<input class='tableActionButton' type='button' id='nav_30' value='month'>
	<input class='tableActionButton' type='button' id='nav_90' value='quarter'>
	<input class='tableActionButton' type='button' id='nav_180' value='half-year'>
	<input class='tableActionButton' type='button' id='nav_365' value='year'>
	&nbsp;
	from:
	<input type='text' id='from' style='width: 80px;'>
	to:
	<input type='text' id='to' style='width: 80px;'>
	<input class='tableActionButton' type='button' id='refresh' value='refresh'>
</div>
<div style='float: right; margin-bottom: 15px; font-family: open_sans,"Helvetica Neue",Helvetica,Roboto,Arial,sans-serif; font-size: 12px;'>
	<input type='checkbox' id='alertAutoRefresh'>
	auto-refresh every 
	<input type='text' id='alertAutoRefreshInterval' value='60' style='width: 40px;'>
	 seconds
</div>

<table id="alertTable" class='genericTable' style='width: 100%;'></table>

<div id='annotationBox' class='ht_popup_annotate_div'>
	<form id='annotationForm'>
	<input type='hidden' name='annotationBoxID' id='annotationBoxID' value='null'>
	<div class='tableTitle'>Add event annotation</div>
	<textarea name='annotateText' id='annotateText' style='margin-bottom: 10px; width: 490px; height: 130px;'></textarea><br>
	<select name='annotateState' id='annotateState' style='margin-bottom: 20px;'>
		<option value='1'>Investigating
		<option value='2'>Completed
	</select>
	<br>
	<input class='tableActionButton postannotation' type='button' value='Add Annotation'>
	<input class='tableActionButton cancelannotation' type='button' value='Cancel' id='annotateCancel'>
	</form>
</div>

{% endblock %}