{% extends "layout.html" %}
{% block title %}HXTool - Indicators{% endblock %}
{% block navlocation %}Manage Indicators{% endblock %}
{% block content %}

<script>
	$(document).ready(function() {


		hxtool_ajax_get_request("/api/v1/indicator_category/get_edit_policies", "", function(myCategoryPolicies) {
			myEditPolicies = JSON.parse(myCategoryPolicies['api_response']);
		});

		var ioc_datatable = $('#iocTable').DataTable( {
			"ajax": "/api/v1/datatable_indicators",
			"paging":   false,
			"ordering": false,
			"info":     false,
			"searching": true,
			"processing": false,
			"dom": '<"hxtool_datatables_buttons"B>frtip',
			"buttons": [
				{ extend: "copy", className: "fe-btn" },
				{ extend: "csv", className: "fe-btn" },
				{ extend: "excel", className: "fe-btn" }
			],
			"columns": [
				{ title: "", "data": "DT_RowId" },
				{ title: "Name", "data": "display_name" },
				{ title: "Active since", "data": "active_since" },
				{ title: "Category", "data": "category_name" },
				{ title: "Created by", "data": "created_by" },
				{ title: "Platforms", "data": "platforms" },
				{ title: "Conditions", "data": "active_conditions" },
				{ title: "Hosts w/alerts", "data": "alerted_agents" },
				{ title: "Action", "data": "DT_RowId" }
			],
			"columnDefs": [	
				{"className": "hxtool_table_cell_center", "targets": [2, 3, 4, 5, 6, 7]},
				{
				 "targets": 0,
				 render: function ( data, type, row, meta ) {
				 	r = "<input data-id='" + row.DT_RowId + "' type='checkbox' />";
				 	return (r);
				 }
				},
				{
				 "targets": 2,
				 render: function ( data, type, row, meta ) {
				 	return (datatables_Timestamp(data));
				 }
				},
				{
				 "targets": 8,
				 "width": "270px",
				 render: function ( data, type, row, meta ) {
				 	r = "";
				 	myId = String(row.category_id);
				 	if (myEditPolicies[myId] == "full" || myEditPolicies[myId] == "edit_delete") {
				 		r += "<button style='margin-right: 6px;' class='iocAction fe-btn fe-btn--sm fe-btn--hxtool-main' data-type='edit' data-id='" + row.DT_RowId + "'>edit</button>";
				 		r += "<button style='margin-right: 6px;' class='iocAction fe-btn fe-btn--sm fe-btn--hxtool-main' data-type='view' data-id='" + row.DT_RowId + "'>view</button>";
				 	}
				 	if (myEditPolicies[myId] == "full" || myEditPolicies[myId] == "edit_delete" || myEditPolicies[myId] == "delete") {
				 		r += "<button style='margin-right: 6px;' class='iocAction fe-btn fe-btn--sm fe-btn--hxtool-main' data-type='remove' data-category='" + row.category_name + "' data-id='" + row.DT_RowId + "'>remove</button>";
				 	}
				 	if (row.category_name != "Custom") {
				 		r += "<button style='margin-right: 6px;' class='iocAction fe-btn fe-btn--sm fe-btn--hxtool-main' data-type='clone' data-id='" + row.DT_RowId + "'>clone</button>";
				 	}
				 	return (r);
				 }
				}
			]
		});
		$('div.dataTables_filter input').addClass("fe-input");

		$("#iocTable").on("click", ".iocAction", function() {
			if ($(this).data("type") == "edit") {
				location.href = "/rtioc?indicator=" + $(this).data("id");
			}
			if ($(this).data("type") == "clone") {
				location.href = "/rtioc?indicator=" + $(this).data("id") + "&clone=true";
			}
			if ($(this).data("type") == "remove") {
				myrow = $(this).closest("tr");
				hxtool_ajax_get_request("/api/v1/indicators/remove", "id=" + $(this).data("id") + "&category=" + $(this).data("category"), function() {
					myrow.fadeOut(200, function() {
						ioc_datatable.row(myrow).remove().draw();
					});
				});
			}
			if ($(this).data("type") == "view") {
				alert("view");
			}
		});

		/*		
		$("#iocTable").on('click', 'button', function(e) {
			e.preventDefault();
			myuuid = $(this).data('id');
			showPopup(500, 900, "/indicatorcondition?uuid=" + myuuid, "myindicatorconditions");
		});
		*/
		
		$('#importIndicator').click(function(){ 
			$('#shader').show();
			$('#importPopup').show();
		});

		$('#importCancel').click(function(){
			$('#importPopup').hide();
			$('#shader').hide();
		});
		
	});
</script>

{{ htPanel.widgetHeader("Action", panelDisplay="inline-block") }}
	<button class="fe-btn fe-btn--md fe-btn--hxtool-main"> Export selected <i style='color: #11a962;' class="fe-icon--right fas fa-search-plus"></i></button>
	<button class="fe-btn fe-btn--md fe-btn--hxtool-main"> Import <i style='color: #11a962;' class="fe-icon--right fas fa-search-plus"></i></button>
	<button class="fe-btn fe-btn--md fe-btn--hxtool-main"> Create new indicator <i style='color: #11a962;' class="fe-icon--right fas fa-search-plus"></i></button>
{{ htPanel.widgetFooter() }}

<!--
<input class='tableActionButton' type='submit' value='Export Selected'>
<input class='tableActionButton' type='button' value='Import indicators' name='importIndicator' id='importIndicator'>
<a href='/rtioc' class='tableActionButton'>Create new indicator</a>
<br>
-->

{{ htPanel.widgetHeader("Indicators", panelId="iocTableContainer") }}
	<table style='width: 100%;' id='iocTable' class='hxtool_table'></table>
{{ htPanel.widgetFooter() }}

<!--
<table style='margin: 0; width: 100%;'>
	<div class='tableTitle'>
			Indicators on the controller
	</div>

	<td style='vertical-align: top;'>
-->
<!--
	</td>
	<td style='width: 30%; vertical-align: top;'>
		<div style='border-top: 2px solid rgb(215,215,215); border-bottom: 2px solid rgb(215,215,215); padding: 10px; font: open_sans,"Helvetica Neue",Helvetica,Roboto,Arial,sans-serif; font-size: 13px; font-weight: 700;'>
			Indicator conditions
		</div>
		<div id='indcond' style='padding: 10px; padding-top: none;'></div>
	</td>
</table>
-->

<div class='shader' id='shader' style='display: none;'>&nbsp;</div>
<div class='importPopup' id='importPopup' style='display: none;'>
	<form method='post' action='/import' enctype='multipart/form-data' style='font-size: 14px; font-weight: bold;'>
		<div class='tableTitle' style='border-bottom: 1px solid rgb(215,215,215); margin-bottom: 15px;'>Import indicators from file</div>
		<br>
		<input type='file' name='iocfile' id='iocfile'><br>
		<br>
		<div style='font-style: italic; margin-bottom: 20px; font-weight: 400;'>- Please note that you need to import a file in the hxTool format. OpenIOC/STIX and other formats are not yet supported</div>
		<input class='tableActionButton' type='submit' value='Import indicators'>
		<input class='tableActionButton' type='button' value='Cancel' id='importCancel'>
	</form>
</div>



{% endblock %}
