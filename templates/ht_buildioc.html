{% extends "layout.html" %}
{% block title %}HXTool - Build IOC{% endblock %}
{% block navlocation %}Build real-time Indicator{% endblock %}
{% block content %}

	<script>
		$(document).ready(function() {

			// Clear field types upon load
			$('#field_types option').each(function() {
				$(this).hide();
			});

			// Change event types
			$('#event_types').change(function() {
				var $id = $(this).val();
				$('#data_type').text("");
				$('#data').val("");

				$('#field_types option').each(function() {
					$(this).hide();
				});

				$('#field_types option').each(function() {
					if(!$(this).val().search($id)) {
						$(this).show();
					}
				});
						
			});

			// Change field types
			$('#field_types').change(function() {
				$('#data').val("");
				var d = ($(this).val());
				var t = $('#' + d).attr('alt');
				$('#data_type').text(t);
			});


			// Add new condition
			$('#button_add').click(function() {

				var neg = 0;

				// Find the index for new condition	
				var ioc_cond_update = "ioc_" + $("[id^=ioc_]").length;

				if($('#' + ioc_cond_update).text() == "") {
					$('#' + ioc_cond_update).append("<div class='iocLabel'>This</div>");
				} else if ($('#check_not').is(':checked')) {
					$('#' + ioc_cond_update).append("<div class='iocLabel iocLabelNot'>and</div>");
					neg = 1;
				} else {
					$('#' + ioc_cond_update).append("<div class='iocLabel'>and</div>");
				}
	
				var event_t = ($('#event_types option:selected').val());
				var field_t = ($('#field_types option:selected').val().split('_').pop());
				var oper_t = ($('#operator option:selected').val());
				var data_s = ($('#data').val());
				var field_ty = ($('#field_types option:selected').attr('alt'))
				//alert(field_ty);
			
				//$('#' + ioc_cond_update).append("<div class='iocBox'>" + event_t + "/" + field_t + " <i>" + oper_t + "</i> <b>" + data_s + "</b>" + "</div>");
			
				if(neg == 0) {
					$('#' + ioc_cond_update).append("<div class='iocBox'>" + event_t + "/" + field_t + " <i>" + oper_t + "</i> <b>" + data_s + "</b>" + "</div>");
					var jsondata = '{"token":"' + event_t + '/' + field_t + '","type":"' + field_ty + '","operator":"' + oper_t + '","value":"' + data_s + '"},';
				} else {
					$('#' + ioc_cond_update).append("<div class='iocBox'>" + event_t + "/" + field_t + " <i><span style='color: red; font-weight: 700;'>not</span> " + oper_t + "</i> <b>" + data_s + "</b>" + "</div>");
					var jsondata = '{"token":"' + event_t + '/' + field_t + '","type":"' + field_ty + '","operator":"' + oper_t + '","value":"' + data_s + '","negate":true},';
				}
			
				var cond_index = $("[id^=ioc_]").length;
				$('#cond_' + cond_index).val($('#cond_' + cond_index).val() + jsondata);
				//$('#cond_1_1').val(jsondata);
			});

			// New presence condition
			$('#button_condpnew').click(function() {
				if ( $("#ht_buildioc_iocframe").css('display') == 'none' ){
					$("#ht_buildioc_iocframe").show();
				}
				var condcnt = $("[id^=ioc_]").length + 1;
				$('<div>').attr({id: 'ioc_' + condcnt,class: 'ioccond'}).appendTo('#ioctd');
				$('#ioc_' + condcnt).html("<div class='cond_title'>Condition #" + condcnt + " - Presence</div>");
				$('<input>').attr({type: 'hidden',id: 'cond_' + condcnt,name: 'cond_' + condcnt + '_presence'}).appendTo('#iocform');
			});

			// New execution condition						
			$('#button_condenew').click(function() {
				if ( $("#ht_buildioc_iocframe").css('display') == 'none' ){
					$("#ht_buildioc_iocframe").show();
				}
				var condcnt = $("[id^=ioc_]").length + 1;
				$('<div>').attr({id: 'ioc_' + condcnt,class: 'ioccond'}).appendTo('#ioctd');
				$('#ioc_' + condcnt).html("<div class='cond_title'>Condition #" + condcnt + " - Execution</div>");
				$('<input>').attr({type: 'hidden',id: 'cond_' + condcnt,name: 'cond_' + condcnt + '_execution'}).appendTo('#iocform');
			});

		});
	</script>

		<div class='tableTitle'>
		        Add a new indicator
		</div>
		<div class='inputArea' style='padding-bottom: 0; width: 920px;'>
                <table style='font-family: open_sans,"Helvetica Neue",Helvetica,Roboto,Arial,sans-serif; font-weight: 400; color: #444;'>
                        <tr>
                                <td style='width: 900px; vertical-align: top;'>
                                        <form style='margin:0;' action='/buildioc' method='POST' id='iocform'>

						<div style='float: left; margin-bottom: 15px;'>
							<span class='menuText'>Indicator Name </span>
	                        <input type='text' name='iocname' value='my_new_ioc'>
							<br><br>
							<span class='menuText'>Platform </span>
							<select name='platform' id='platform'>
								<option value='win'>Microsoft Windows
								<option value='osx'>Apple OS X
								<option value='all'>All
							</select>
						</div>
						<div style='float: right; margin-bottom: 15px;'>
							<span class='menuText'>Indicator Category </span>
							{% if cats %} {{ cats|safe }} {% endif %}						
						</div>
						<div style='clear: both;'></div>
						<div class='menuText'><b>Please note:</b> <i>Indicator field and event types are not updated to reflect platform. Please be careful when constructing indicators so you are using event types that are supported on your specific platform</i></div>

                                                <div style='float: left; padding: 20px; padding-left: 0; border: 1px solid rgb(215,215,215); border-left: 0;'>
                                                <div class='menuText'>Event Types</div>
                                                <div>
                                                <select id='event_types' name='event_types' class='ht_buildioc_eventSelector' MULTIPLE>
                                                        <option value='imageLoadEvent'>imageLoadEvent
                                                        <option value='processEvent'>processEvent
                                                        <option value='fileWriteEvent'>fileWriteEvent
                                                        <option value='regKeyEvent'>regKeyEvent
                                                        <option value='dnsLookupEvent'>dnsLookupEvent
                                                        <option value='ipv4NetworkEvent'>ipv4NetworkEvent
                                                        <option value='urlMonitorEvent'>urlMonitorEvent
                                                        <option value='addressNotificationEvent'>addressNotificationEvent
                                                </select>
                                                </div>
                                                </div>

                                                <div style='float: left; padding: 20px; border: 1px solid rgb(215,215,215); border-left: 0;'>
                                                <div class='menuText'>Field Types</div>
                                                <div>
                                                <select id='field_types' name='field_types' style='width: 160px;' class='ht_buildioc_eventSelector' MULTIPLE>
                                                        <option id='imageLoadEvent_fullPath' alt='text' value='imageLoadEvent_fullPath'>fullPath
                                                        <option id='imageLoadEvent_devicePath' alt='text' value='imageLoadEvent_devicePath'>devicePath
                                                        <option id='imageLoadEvent_drive' alt='text' value='imageLoadEvent_drive'>drive
                                                        <option id='imageLoadEvent_filePath' alt='text' value='imageLoadEvent_filePath'>filePath
                                                        <option id='imageLoadEvent_fileName' alt='text' value='imageLoadEvent_fileName'>fileName
                                                        <option id='imageLoadEvent_fileExtension' alt='text' value='imageLoadEvent_fileExtension'>fileExtension
                                                        <option id='imageLoadEvent_pid' alt='integer' value='imageLoadEvent_pid'>pid
                                                        <option id='imageLoadEvent_process' alt='text' value='imageLoadEvent_process'>process
                                                        <option id='imageLoadEvent_parentPid' alt='integer' value='imageLoadEvent_parentPid'>parentPid
                                                        <option id='imageLoadEvent_username' alt='text' value='imageLoadEvent_username'>username
                                                        <option id='imageLoadEvent_error' alt='text' value='imageLoadEvent_error'>error
                                                        <option id='processEvent_eventType' alt='text' value='processEvent_eventType'>eventType
                                                        <option id='processEvent_pid' alt='integer' value='processEvent_pid'>pid
                                                        <option id='processEvent_processPath' alt='text' value='processEvent_processPath'>processPath
                                                        <option id='processEvent_process' alt='text' value='processEvent_process'>process
                                                        <option id='processEvent_parentPid' alt='integer' value='processEvent_parentPid'>parentPid
                                                        <option id='processEvent_parentProcessPath' alt='text' value='processEvent_parentProcessPath'>parentProcessPath
                                                        <option id='processEvent_parentProcess' alt='text' value='processEvent_parentProcess'>parentProcess
                                                        <option id='processEvent_username' alt='text' value='processEvent_username'>username
                                                        <option id='processEvent_startTime' alt='text' value='processEvent_startTime'>startTime
                                                        <option id='processEvent_processCmdLine' alt='text' value='processEvent_processCmdLine'>processCmdLine
                                                        <option id='processEvent_md5' alt='md5' value='processEvent_md5'>md5
                                                        <option id='fileWriteEvent_fullPath' alt='text' value='fileWriteEvent_fullPath'>fullPath
                                                        <option id='fileWriteEvent_devicePath' alt='text' value='fileWriteEvent_devicePath'>devicePath
                                                        <option id='fileWriteEvent_drive' alt='text' value='fileWriteEvent_drive'>drive
                                                        <option id='fileWriteEvent_filePath' alt='text' value='fileWriteEvent_filePath'>filePath
                                                        <option id='fileWriteEvent_fileName' alt='text' value='fileWriteEvent_fileName'>fileName
                                                        <option id='fileWriteEvent_fileExtension' alt='text' value='fileWriteEvent_fileExtension'>fileExtension
                                                        <option id='fileWriteEvent_size' alt='integer' value='fileWriteEvent_size'>size
                                                        <option id='fileWriteEvent_md5' alt='md5' value='fileWriteEvent_md5'>md5
                                                        <option id='fileWriteEvent_pid' alt='integer' value='fileWriteEvent_pid'>pid
                                                        <option id='fileWriteEvent_process' alt='text' value='fileWriteEvent_process'>process
                                                        <option id='fileWriteEvent_writes' alt='integer' value='fileWriteEvent_writes'>writes
                                                        <option id='fileWriteEvent_numBytesSeenWritten' alt='integer' value='fileWriteEvent_numBytesSeenWritten'>numBytesSeenWritten
                                                        <option id='fileWriteEvent_lowestFileOffsetSeen' alt='integer' value='fileWriteEvent_lowestFileOffsetSeen'>lowestFileOffsetSeen
                                                        <option id='fileWriteEvent_dataAtLowestOffset' alt='text' value='fileWriteEvent_dataAtLowestOffset'>dataAtLowestOffset
                                                        <option id='fileWriteEvent_textAtLowestOffset' alt='text' value='fileWriteEvent_textAtLowestOffset'>textAtLowestOffset
                                                        <option id='fileWriteEvent_closed' alt='text' value='fileWriteEvent_closed'>closed
                                                        <option id='fileWriteEvent_error' alt='text' value='fileWriteEvent_error'>error
                                                        <option id='regKeyEvent_path' alt='text' value='regKeyEvent_path'>path
                                                        <option id='regKeyEvent_hive' alt='text' value='regKeyEvent_hive'>hive
                                                        <option id='regKeyEvent_keyPath' alt='text' value='regKeyEvent_keyPath'>keyPath
                                                        <option id='regKeyEvent_eventType' alt='text' value='regKeyEvent_eventType'>eventType
                                                        <option id='regKeyEvent_valueName' alt='text' value='regKeyEvent_valueName'>valueName
                                                        <option id='regKeyEvent_valueType' alt='text' value='regKeyEvent_valueType'>valueType
                                                        <option id='regKeyEvent_value' alt='text' value='regKeyEvent_value'>value
                                                        <option id='regKeyEvent_text' alt='text' value='regKeyEvent_text'>text
                                                        <option id='dnsLookupEvent_hostname' alt='text' value='dnsLookupEvent_hostname'>hostname
                                                        <option id='dnsLookupEvent_pid' alt='integer' value='dnsLookupEvent_pid'>pid
                                                        <option id='dnsLookupEvent_process' alt='text' value='dnsLookupEvent_process'>process
                                                        <option id='ipv4NetworkEvent_remoteIP' alt='text' value='ipv4NetworkEvent_remoteIP'>remoteIP
                                                        <option id='ipv4NetworkEvent_remotePort' alt='integer' value='ipv4NetworkEvent_remotePort'>remotePort
                                                        <option id='ipv4NetworkEvent_localIP' alt='text' value='ipv4NetworkEvent_localIP'>localIP
                                                        <option id='ipv4NetworkEvent_localPort' alt='integer' value='ipv4NetworkEvent_localPort'>localPort
                                                        <option id='ipv4NetworkEvent_protocol' alt='text' value='ipv4NetworkEvent_protocol'>protocol
                                                        <option id='ipv4NetworkEvent_pid' alt='integer' value='ipv4NetworkEvent_pid'>pid
                                                        <option id='ipv4NetworkEvent_process' alt='text' value='ipv4NetworkEvent_process'>process
                                                        <option id='urlMonitorEvent_hostname' alt='text' value='urlMonitorEvent_hostname'>hostname
                                                        <option id='urlMonitorEvent_requestUrl' alt='text' value='urlMonitorEvent_requestUrl'>requestUrl
                                                        <option id='urlMonitorEvent_urlMethod' alt='text' value='urlMonitorEvent_urlMethod'>urlMethod
                                                        <option id='urlMonitorEvent_userAgent' alt='text' value='urlMonitorEvent_userAgent'>userAgent
                                                        <option id='urlMonitorEvent_httpHeader' alt='text' value='urlMonitorEvent_httpHeader'>httpHeader
                                                        <option id='urlMonitorEvent_remoteIpAddress' alt='text' value='urlMonitorEvent_remoteIpAddress'>remoteIpAddress
                                                        <option id='urlMonitorEvent_remotePort' alt='integer' value='urlMonitorEvent_remotePort'>remotePort
                                                        <option id='urlMonitorEvent_localPort' alt='integer' value='urlMonitorEvent_localPort'>localPort
                                                        <option id='urlMonitorEvent_pid' alt='integer' value='urlMonitorEvent_pid'>pid
                                                        <option id='urlMonitorEvent_process' alt='text' value='urlMonitorEvent_process'>process
                                                        <option id='urlMonitorEvent_processPath' alt='text' value='urlMonitorEvent_processPath'>processPath
                                                        <option id='urlMonitorEvent_username' alt='text' value='urlMonitorEvent_username'>username
                                                        <option id='urlMonitorEvent_error' alt='text' value='urlMonitorEvent_error'>error
                                                        <option id='addressNotificationEvent_address' alt='text' value='addressNotificationEvent_address'>address
                                                </select>
                                                </div>
                                                </div>

                                                <div style='float: left; padding: 20px; padding-right: 0; width: 490px; border: 1px solid rgb(215,215,215); border-left: 0; border-right: 0; border-bottom: 0;'>
                                                <div class='menuText'>Operator and matching data</div>
                                                <div class='menuText'>
                                                <input type='checkbox' id='check_not'>NOT
                                                <select id='operator'>
                                                        <option value='contains'>contains
                                                        <option value='equal'>equal
                                                        <option value='matches'>matches
                                                </select>

                                                Enter a <span id='data_type' style='color: green; font-weight: bold;'></span> value<br>
                                                <input type='text' id='data' style='width: 400px; margin-top: 10px;'>
                                                </div>
						<br>
                                                <input class='iocButton' type='button' id='button_add' value='Add selection...'>
						<br><br><br>
                                                <input class='iocButton' type='button' id='button_condpnew' value='New presence condition'>
                                                <input class='iocButton' type='button' id='button_condenew' value='New execution condition'>
                                                </div>

                                                <div style='clear: both;'>
                                                        <input type='hidden' id='datajson' name='datajson' value=''>
							<br>
                                                        <input class='iocButton' type='submit' value='Create indicator...'>
							<br>
							<br>
                                                </div>

                                                <div class='ht_content_box' style='margin-top: 10px; display: none; float: left;' id='resultsbox'>
                                                <div class='ht_content_boxtitle'>HX Output</div>
                                                <div class='ht_content_boxcontent' id='results'>
                                                </div>
                                                </div>
                                                <div style='clear: both;'>
                                        </form>
                                </td>
                        </tr>
                </table>
		</div>

		<br>

		<div class='ht_buildioc_iocframe' id='ht_buildioc_iocframe' style='z-index: 1;'>
			<table class='ht_buildioc_ioctable'>
				<tr>
					<td id='ioctd'>
					</td>
				</tr>
			</table>
		</div>

{% endblock %}
